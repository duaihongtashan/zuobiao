# 圆形检测功能使用指南

## 功能概述

截图工具现已集成基于OpenCV HoughCircles算法的智能圆形检测和截图功能。该功能可以自动识别图像中的圆形区域，并进行精确的圆形截图。

## 核心特性

### ✨ 智能检测
- **HoughCircles算法**: 基于OpenCV成熟的圆形检测算法
- **自适应参数**: 可根据图像特征自动调整检测参数
- **置信度评估**: 为每个检测到的圆形提供置信度评分
- **结果过滤**: 自动过滤重叠和低质量的检测结果

### 🎯 精确截图
- **圆形蒙版**: 生成高精度的圆形蒙版
- **抗锯齿处理**: 4倍超采样确保圆形边缘平滑
- **透明背景**: 支持PNG透明背景格式
- **批量处理**: 同时截图多个检测到的圆形

### 📊 结构化数据
- **检测数据**: JSON格式保存所有检测信息
- **用户调整**: 记录用户对检测结果的手动调整
- **元数据**: 包含时间戳、参数设置、文件关联等信息

## 安装依赖

在使用圆形检测功能前，需要安装额外的Python依赖：

```bash
# 安装OpenCV和NumPy
pip install opencv-python>=4.8.0 numpy>=1.21.0

# 或使用uv（推荐）
uv add opencv-python numpy
```

## 使用方法

### 1. 启动程序

```bash
# 智能启动（推荐）
python jietu.py

# 直接启动GUI
python main.py
```

### 2. 启用圆形检测

1. 在GUI界面中找到"圆形检测功能"区域
2. 勾选"启用圆形检测"复选框
3. 调整检测参数（可选）

### 3. 设置检测区域

1. 在"截图区域设置"中设定要检测的区域
2. 可以使用"记录左上角"和"记录右下角"按钮精确选择区域
3. 点击"应用区域"确认设置

### 4. 执行圆形检测

1. 点击"检测圆形"按钮
2. 程序将在指定区域内搜索圆形
3. 检测结果会显示在界面上，包括：
   - 检测到的圆形数量
   - 每个圆形的置信度

### 5. 截图圆形

1. 检测完成后，点击"截图圆形"按钮
2. 程序将为每个检测到的圆形生成独立的截图文件
3. 截图保存在`screenshots/circles/`目录下

## 参数调整

### 检测参数说明

| 参数 | 说明 | 推荐范围 | 默认值 |
|------|------|----------|--------|
| 最小半径 | 检测的最小圆形半径（像素） | 5-50 | 10 |
| 最大半径 | 检测的最大圆形半径（像素） | 50-300 | 100 |
| 最小距离 | 圆心间的最小距离（像素） | 20-150 | 50 |
| 检测阈值 | HoughCircles的param2参数 | 20-80 | 30 |

### 参数调优建议

**检测不到圆形时**：
- 降低"检测阈值"（如从30降到20）
- 调整"最小半径"和"最大半径"范围
- 确保图像中的圆形轮廓清晰

**误检太多时**：
- 提高"检测阈值"（如从30升到40）
- 增加"最小距离"以避免重复检测
- 缩小半径检测范围

**圆形大小不合适时**：
- 根据实际情况调整"最小半径"和"最大半径"
- 使用"记录坐标"功能精确测量目标圆形大小

## 输出文件

### 圆形截图文件
- **文件名格式**: `circle_01_20250703_120000.png`
- **保存位置**: `screenshots/circles/`
- **格式**: PNG（支持透明背景）
- **内容**: 圆形区域的精确截图

### 组合图像（可选）
- **文件名格式**: `circles_combined_20250703_120000.png`
- **内容**: 所有圆形截图的水平拼接

### 检测数据文件
- **文件名格式**: `circle_detection_data_20250703_120000.json`
- **保存位置**: `screenshots/circle_data/`
- **内容**: 完整的检测信息和元数据

### 示例JSON数据结构

```json
{
  "detection_info": {
    "timestamp": "20250703_120000",
    "datetime": "2025-07-03T12:00:00",
    "total_detected": 3,
    "successful_captures": 3,
    "source_image_shape": [1080, 1920, 3]
  },
  "circles": [
    {
      "index": 1,
      "center": {"x": 150, "y": 200},
      "radius": 45,
      "confidence": 0.8524,
      "adjusted": false,
      "original_center": {"x": 150, "y": 200},
      "original_radius": 45
    }
  ],
  "output_files": {
    "individual_files": [...],
    "combined_file": {...}
  }
}
```

## 配置文件

圆形检测相关的配置会自动保存在`config.json`中：

```json
{
  "circle_detection": {
    "enabled": true,
    "hough_params": {
      "dp": 1.0,
      "min_dist": 50,
      "param1": 50,
      "param2": 30,
      "min_radius": 10,
      "max_radius": 100
    },
    "preprocessing": {
      "blur_kernel_size": 5,
      "median_blur_size": 5,
      "use_clahe": true,
      "clahe_clip_limit": 2.0,
      "clahe_tile_grid_size": [8, 8]
    },
    "capture": {
      "save_individual": true,
      "save_combined": false,
      "transparent_background": true,
      "padding": 10,
      "anti_alias": true
    }
  }
}
```

## 最佳实践

### 1. 图像准备
- 确保圆形轮廓清晰可见
- 避免过度复杂的背景
- 保持良好的对比度

### 2. 区域选择
- 选择包含目标圆形的最小区域
- 避免包含不必要的干扰元素
- 确保圆形完全在选择区域内

### 3. 参数设置
- 从默认参数开始，根据结果逐步调整
- 记录有效的参数组合用于类似场景
- 定期保存设置以便下次使用

### 4. 结果验证
- 检查检测结果的置信度
- 验证圆形的位置和大小是否正确
- 必要时清除结果重新检测

## 故障排除

### 问题：检测不到任何圆形
**解决方案**：
1. 检查图像中是否有清晰的圆形轮廓
2. 降低检测阈值参数
3. 调整半径范围
4. 确认截图区域是否正确

### 问题：检测到的圆形不准确
**解决方案**：
1. 提高检测阈值以减少误检
2. 调整最小距离参数
3. 优化图像预处理参数
4. 手动调整检测结果

### 问题：截图质量不佳
**解决方案**：
1. 启用抗锯齿处理
2. 增加边界填充
3. 检查原始图像质量
4. 调整圆形检测精度

### 问题：性能较慢
**解决方案**：
1. 减小检测区域大小
2. 限制半径检测范围
3. 降低图像分辨率
4. 关闭不必要的预处理选项

## 技术细节

### 算法原理
- 基于OpenCV的`cv2.HoughCircles()`函数
- 使用Canny边缘检测进行预处理
- 通过霍夫变换在参数空间中检测圆形
- 应用非极大值抑制避免重复检测

### 性能优化
- 多线程处理避免UI阻塞
- 图像金字塔加速大图像处理
- 智能缓存减少重复计算
- 内存优化处理大量圆形

### 扩展性
- 模块化设计便于功能扩展
- 插件式参数系统支持自定义算法
- 标准化接口便于集成其他检测算法
- 完整的配置管理支持个性化设置

## 更新日志

### v1.0.0 (2025-07-03)
- ✨ 首次发布圆形检测功能
- 🎯 实现基于HoughCircles的智能检测
- 📸 支持高质量圆形截图
- ⚙️ 完整的参数配置系统
- 📊 结构化数据存储
- 🖥️ 友好的GUI界面集成

---

## 技术支持

如遇到问题或需要帮助，请：
1. 查看本文档的故障排除部分
2. 运行`python test_syntax.py`检查安装状态
3. 检查依赖是否正确安装：`pip list | grep opencv`

祝您使用愉快！ 🎉